This exploration is all about the single dataflow exploration of a given workload on an event driven archecture using the tools Zigzag(Single core exploration) and Stream (Multi core exploration)

# Overall Todo list
- [ ] Taking details from the background study on how the Frame based execution and the Event based execution occurs and also the combination of the possible mapping to run the effect on latency and the energy and the EDP is as follows: (Validation process)

[From the background study, 1. Frame based execution, 2. Event based execution]

- [ ] Zigzag lenet 5 model implementation on the following architecture and possible mapping
    - [ ] Results of Latency, energy and EDP (Single bar graph)

- [ ] Stream lenet 5 model implementation on the following architecture and possible mapping
    - [ ] Results of latency, energy and EDP (Single bar graph)

- [ ] Upon validation of the Zigzag and Stream for the lenet 5 model the follwing results are supposed to be achieved
    - [ ]Results of latency, energy and EDP (double bar graph) - With comparision of the both and the change in the results

- [ ] Implication of this difference on the current solution and the exploration

- [ ] How to get all the possible mappings combination to do the test?

- [ ]Proposed solution implementation.

# [For 24/03 submision]
 - [x] Write about the validation process using the simulator
        - [x] Indicate about the execssive partial sums which are being generate that effects the latency which needs to be validated and compensated in the end
        - [x] Take a simple exmple for now and show the reading by hand or python script
        - [x] End with a need to verify this and will be developed within this week

 - [x] Single core implementation using Zigzag
        - [x] Lenet 1st layer readings tabular readings for different mappings (3 tables possible)
        - [x] Present the information in the bar graph form for the latency, Energy and Energy Delay product
        - [x] Lenet compete model in the 1 core implementation
            - [x] Tabular readings for different mappings
            - [x] Present the information in the graph form
    - [x] End with a statement says that for event driven the value should be less as explained in the validation section will be getting that within this week

 - [ ] Multi-core implementation using stream (For kanishkan)
        - [x] Explain about the two major challenges faced and currently being resolved
            - [x] Stream doesn't accept the YAML file as input and only ONNX file. So, the input stationary results are difficult to get and need some modification
                - [ ] Work around being followed
            - [x] Stream doesn't give the intra core loop ordering and the stats are mostly in terms in latency due to which there needs to be some work to get the required results
 - [ ] Plan for the this week (In a ppt)
        - [ ] Managing to make the stream work for the 2 core archtecture with the Lenet - 5 model
        - [ ] A validation program for the zigzag results
        - [ ] A final consolidated results from Zigzag with validation, Basic results from Stream for multi core exploration


---------------------------------------------------------------------------------------------------------------------------------------------------------------
# Validation process 
Validation process is the step where the results generated by the Zigzag and Stream are verified with a program which mimics the architecture being modelled and executed the workload and gives the final word access count, partial sums generated and finally the latency, energy and energy delay product.

An example is selected to explain the validation process and also why it is required:

Step 1: Selection of the workload:
The workload considered  is as follows:

Input - [1,1,5,5]
Weights(Kernels) - [8,1,3,3]
Outputs - [1,8,3,3]

Step 2: Frame-based execution of the workload:

For the mapping as follows:

```
==============================
Temporal Loops                
==============================
for FX in [0, 3):             
------------------------------
  for FY in [0, 3):           
------------------------------
    for OX in [0, 3):         
------------------------------
      for OY in [0, 3):       
------------------------------
==============================
Spatial Loops                 
==============================
        parfor K in [0, 8):   
------------------------------
```

The wordaccess, partial sum and latency are as follows:

|                | Description                         |
|----------------|-------------------------------------|
| **Word Access**| Inputs: 81, Weights: 9, Outputs: 81 |
| **Partial Sum**| 8 * 81 = 648 (across 8 NPEs)        |
| **Latency**    | Off: 0, Comp: 81, On: 0             |

Step 3: Event-based execution of the workload

Here the output given by the Zigzag is as follows:

Mapping:
```
==============================
Temporal Loops                
==============================
for FX in [0, 3):             
------------------------------
  for FY in [0, 3):           
------------------------------
    for IX in [0, 5):         
------------------------------
      for IY in [0, 5):       
------------------------------
==============================
Spatial Loops                 
==============================
        parfor K in [0, 8):   
------------------------------
```
The wordaccess, partial sum and latency are as follows:
|                | Description                           |
|----------------|---------------------------------------|
| **Word Access**| Inputs: 9, Weights: 225, Outputs: 225 |
| **Partial Sum**| 8 * 225 = 1800 (across 8 NPEs)        |
| **Latency**    | Off: 0, Comp: 225, On: 0              |

Step 3: Comparision and the implication of any difference in the results

But, Upon validating this above mapping the actual wordaccess, Partial sum and latency are as follows:

|                | Description                           |
|----------------|---------------------------------------|
| **Word Access**| Inputs: 9, Weights: 225, Outputs: 81  |
| **Partial Sum**| 8 * 81 = 648 (across 8 NPEs)          |
| **Latency**    | Off: 0, Comp: 81, On: 0               |

Here are the comparision of all the generated stats

![Validation_stats](attachments/validation_process.png)


This is a 94% b/w the expected event driven latency value in comparision with the actual zigzag stats value generated by the exploration. This overestimation will lead to a problem when the same cost model is used multi-core exploration and this difference in the latency need to be accounted for.

This above process is just an example of how the validation will be done for the lenet model to support this problem and solution will be proposed to address it.


- [ ] Effect of this excess word access, partial sum on latency due to the cost model -> Need to be added to support the result further

# Zigzag Exploration Results

Step 1: The workload considered is as follows:

This is the 1st layer of the Lenet-5 model:
Input: 32x32x1
C1: 6 filters, 5x5 kernel, output 28x28x6

Step 2: Generation of the results
Here are results from the zigzag exploration

Mapping 1
```
======================================================================================================================
Temporal Loops                 O                            W                            I                            
======================================================================================================================
for IY in [0, 32):             sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
  for IX in [0, 32):           sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
    for FY in [0, 5):          sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
      for FX in [0, 5):        sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
======================================================================================================================
Spatial Loops                                                                                                         
======================================================================================================================
        parfor K in [0, 6):                                                                                           
----------------------------------------------------------------------------------------------------------------------
```
The stats are as follows

|                | Description                                   |
|----------------|-----------------------------------------------|
| **Word Access**| Inputs: 1024, Weights: 25600, Outputs: 25600  |
| **Partial Sum**| 6 * 25600 = 153600 (across 8 NPEs)            |
| **Latency**    | Off: 0, Comp: 25600, On: 0                    |
| **Energy**     | 882176.0 pj                                   |

Mapping 2
```
======================================================================================================================
Temporal Loops                 O                            W                            I                            
======================================================================================================================
for IY in [0, 32):             sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
  for IX in [0, 32):           sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
    for K in [0, 6):           sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
      for FY in [0, 5):        sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
======================================================================================================================
Spatial Loops                                                                                                         
======================================================================================================================
        parfor FX in [0, 5):                                                                                          
----------------------------------------------------------------------------------------------------------------------
```
The stats are as follows

|                | Description                                   |
|----------------|-----------------------------------------------|
| **Word Access**| Inputs: 1024, Weights: 30720, Outputs: 30720  |
| **Partial Sum**| 5 * 30720 = 153600 (across 8 NPEs)            |
| **Latency**    | Off: 0, Comp: 30720, On: 0                    |
| **Energy**     | 1055232.0 pj                                  |


Mapping 3
```
======================================================================================================================
Temporal Loops                 O                            W                            I                            
======================================================================================================================
for IY in [0, 32):             sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
  for IX in [0, 32):           sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
    for FX in [0, 5):          sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
      for K in [0, 6):         sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
======================================================================================================================
Spatial Loops                                                                                                         
======================================================================================================================
        parfor FY in [0, 5):                                                                                          
----------------------------------------------------------------------------------------------------------------------
```

The stats are as follows
|                | Description                                   |
|----------------|-----------------------------------------------|
| **Word Access**| Inputs: 1024, Weights: 30720, Outputs: 30720  |
| **Partial Sum**| 5 * 30720 = 153600 (across 8 NPEs)            |
| **Latency**    | Off: 0, Comp: 30720, On: 0                    |
| **Energy**     | 1055232.0 pj                                  |

Moving on with the Lenet - 5 model execution

Step 1: The workload considered is as follows:

The Lenet - 5 Model:

Input: 32x32x1
C1: 6 filters, 5x5 kernel, output 28x28x6
S2: 2x2 average pooling, stride=2, output 14x14x6
C3: 16 filters, 5x5 kernel, output 10x10x16
S4: 2x2 average pooling, stride=2, output 5x5x16
C5: 120 filters, 5x5 kernel (or fully connected), output 120
F6: Fully connected, output 84
Output: Fully connected, output 10

The ONNX of the model is as follows:

An mapping generated by the zigzag when the model is run one layer at a time is as follows

```
Loop ordering for layer_1
======================================================================================================================
Temporal Loops                 O                            W                            I                            
======================================================================================================================
for IY in [0, 32):             sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
  for IX in [0, 32):           sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
    for FY in [0, 5):          sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
      for FX in [0, 5):        sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
======================================================================================================================
Spatial Loops                                                                                                         
======================================================================================================================
        parfor K in [0, 6):                                                                                           
----------------------------------------------------------------------------------------------------------------------

Loop ordering for pooling_layer_1
======================================================================================================================
Temporal Loops                 O                            W                            I                            
======================================================================================================================
for IY in [0, 28):             sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
  for IX in [0, 28):           sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
    for FY in [0, 2):          sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
      for FX in [0, 2):        sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
----------------------------------------------------------------------------------------------------------------------
======================================================================================================================
Spatial Loops                                                                                                         
======================================================================================================================
        parfor G in [0, 6):                                                                                           
----------------------------------------------------------------------------------------------------------------------

Loop ordering for layer_2
==========================================================================================================================
Temporal Loops                     O                            W                            I                            
==========================================================================================================================
for IY in [0, 14):                 sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
--------------------------------------------------------------------------------------------------------------------------
  for IX in [0, 14):               sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
--------------------------------------------------------------------------------------------------------------------------
    for C in [0, 6):               sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
--------------------------------------------------------------------------------------------------------------------------
      for FY in [0, 5):            sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
--------------------------------------------------------------------------------------------------------------------------
        for FX in [0, 5):          sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
--------------------------------------------------------------------------------------------------------------------------
          for K in [0, 2):         sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
--------------------------------------------------------------------------------------------------------------------------
==========================================================================================================================
Spatial Loops                                                                                                             
==========================================================================================================================
            parfor K in [0, 8):                                                                                           
--------------------------------------------------------------------------------------------------------------------------

Loop ordering for pooling_layer_2
========================================================================================================================
Temporal Loops                   O                            W                            I                            
========================================================================================================================
for IY in [0, 10):               sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
------------------------------------------------------------------------------------------------------------------------
  for IX in [0, 10):             sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
------------------------------------------------------------------------------------------------------------------------
    for FY in [0, 2):            sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
------------------------------------------------------------------------------------------------------------------------
      for FX in [0, 2):          sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
------------------------------------------------------------------------------------------------------------------------
        for G in [0, 2):         sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
------------------------------------------------------------------------------------------------------------------------
========================================================================================================================
Spatial Loops                                                                                                           
========================================================================================================================
          parfor G in [0, 8):                                                                                           
------------------------------------------------------------------------------------------------------------------------

Loop ordering for layer_3
==========================================================================================================================
Temporal Loops                     O                            W                            I                            
==========================================================================================================================
for IY in [0, 5):                  sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
--------------------------------------------------------------------------------------------------------------------------
  for IX in [0, 5):                sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
--------------------------------------------------------------------------------------------------------------------------
    for C in [0, 16):              sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
--------------------------------------------------------------------------------------------------------------------------
      for FY in [0, 5):            sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
--------------------------------------------------------------------------------------------------------------------------
        for FX in [0, 5):          sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
--------------------------------------------------------------------------------------------------------------------------
          for K in [0, 15):        sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
--------------------------------------------------------------------------------------------------------------------------
==========================================================================================================================
Spatial Loops                                                                                                             
==========================================================================================================================
            parfor K in [0, 8):                                                                                           
--------------------------------------------------------------------------------------------------------------------------

Loop ordering for layer_4
=================================================================================================================
Temporal Loops            O                            W                            I                            
=================================================================================================================
for C in [0, 120):        sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
-----------------------------------------------------------------------------------------------------------------
  for K in [0, 14):       sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
-----------------------------------------------------------------------------------------------------------------
=================================================================================================================
Spatial Loops                                                                                                    
=================================================================================================================
    parfor K in [0, 6):                                                                                          
-----------------------------------------------------------------------------------------------------------------

Loop ordering for layer_5
=================================================================================================================
Temporal Loops            O                            W                            I                            
=================================================================================================================
for C in [0, 84):         sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
-----------------------------------------------------------------------------------------------------------------
  for K in [0, 2):        sram_256KB                   sram_256KB                   sram_buffer_inputs_256KB     
-----------------------------------------------------------------------------------------------------------------
=================================================================================================================
Spatial Loops                                                                                                    
=================================================================================================================
    parfor K in [0, 5):                                                                                          
-----------------------------------------------------------------------------------------------------------------
```

The Overall stats are as follows
|                | Description                                   |
|----------------|-----------------------------------------------|
| **Latency**    | 240184.0                                      |
| **Energy**     | 8193170.64 pj                                 |

The stats of the entire lenet - 5 model running on the single core is as follows

<!-- |   Layer_1      | Description                                   |
|----------------|-----------------------------------------------|
| **Word Access**| Inputs: 1024, Weights: 25600, Outputs: 25600  |
| **Partial Sum**| 6 * 25600 = 153600 (across 6 NPEs)            |
| **Latency**    | Off: 0, Comp: 25600, On: 0                    |
| **Energy**     | 882176.0 pj                                   |

|   Pooling_layer| Description                                   |
|----------------|-----------------------------------------------|
| **Word Access**| Inputs: 784, Weights: 3136,  Outputs: 3136    |
| **Partial Sum**| 6 * 3136 = 18816 (across 6 NPEs)              |
| **Latency**    | Off: 0, Comp: 3136, On: 0                     |
| **Energy**     | 82053.44 pj                                   |

|    Layer_2     | Description                                   |
|----------------|-----------------------------------------------|
| **Word Access**| Inputs: 1176, Weights: 58800, Outputs: 58800  |
| **Partial Sum**| 8 * 58800 = 470400 (across 8 NPEs)            |
| **Latency**    | Off: 0, Comp: 58800, On: 0                    |
| **Energy**     | 2018604.0 pj                                  |

| Pooling_layer_1| Description                                   |
|----------------|-----------------------------------------------|
| **Word Access**| Inputs: 1024, Weights: 25600, Outputs: 25600  |
| **Partial Sum**| 8 * 25600 = 204800 (across 8 NPEs)            |
| **Latency**    | Off: 0, Comp: 25600, On: 0                    |
| **Energy**     | 882176.0 pj                                   |

|    Layer_3     | Description                                   |
|----------------|-----------------------------------------------|
| **Word Access**| Inputs: 800, Weights: 400, Outputs: 800       |
| **Partial Sum**| 8 * 800 = 6400 (across 8 NPEs)                |
| **Latency**    | Off: 0, Comp: 800, On: 0                      |
| **Energy**     | 882176.0 pj                                   |

|    FC_1        | Description                                   |
|----------------|-----------------------------------------------|
| **Word Access**| Inputs: 120, Weights: 1680, Outputs: 1680     |
| **Partial Sum**| 6 * 1680 = 10080 (across 8 NPEs)              |
| **Latency**    | Off: 0, Comp: 1680, On: 0                     |
| **Energy**     | 58447.2 pj                                    |

|    FC_2        | Description                                   |
|----------------|-----------------------------------------------|
| **Word Access**| Inputs: 84, Weights: 168, Outputs: 168        |
| **Partial Sum**| 5 * 168 = 840 (across 8 NPEs)                 |
| **Latency**    | Off: 0, Comp: 168, On: 0                      |
| **Energy**     | 6594.0 pj                                     | -->

![Lenet-5 model stats](attachments/lenet_5_model_single_core.png)

Note: Now, On validating these above results there will be a variation on the latency b/w the Zigzag output and the latency that should be there for the actual event driven accelerator this variation is due to the excess computation of the partial sums which is explained through a simple example in the validation section and the same process will be repeated for this case here too.

# Expected Validation Results

# Zigzag Exploration Results

The follwoing architecture and the workload is executed on the Stream

2 core accelerator architecture

![2 core accelerator architecture](attachments/2_core_architecture.png)

The configuration of the single core of the above accelerator is as follows

```
name: accelerator1

operational_array:
  unit_energy: 0.04 # pJ
  unit_area: 1 # unit
  dimensions: [D1]
  sizes: [8]

memories:
  sram_buffer_inputs_256KB: # define in bits (size: 16x1024x8)
    size: 2097152
    r_bw: 128
    w_bw: 128
    r_cost: 10.5
    w_cost: 12.8
    area: 0
    r_port: 1
    w_port: 0
    rw_port: 0
    latency: 1
    operands: [I1]
    ports:
      - tl: r_port_1
    served_dimensions: [D1]

#This is just used to store the input values from the DRAM to be read to the RF
  sram_256KB:
    size: 2097152
    r_bw: 128
    w_bw: 128
    r_cost: 10.5
    w_cost: 12.8
    area: 0
    r_port: 3
    w_port: 3
    rw_port: 0
    latency: 1
    operands: [I2, O]
    ports:
      - tl: r_port_1
        fl: w_port_1
      - fh: w_port_2
        tl: r_port_2
        fl: w_port_3
        th: r_port_3
    served_dimensions: [D1]
```

Offchip memory configuration
```
name: offchip

memories:
  dram:
    size: 4294967296
    r_bw: 64
    w_bw: 64
    r_cost: 100
    w_cost: 150
    area: 0
    r_port: 0
    w_port: 0
    rw_port: 1
    latency: 1
    operands: [I1, I2, O]
    ports:
      - fh: rw_port_1
        tl: rw_port_1
      - fh: rw_port_1
        tl: rw_port_1
      - fh: rw_port_1
        tl: rw_port_1
        fl: rw_port_1
        th: rw_port_1
    served_dimensions: [D1]

operational_array:
  unit_energy: 0
  unit_area: 0
  dimensions: [D1]
  sizes: [0]
```

HDA_Bus

```
name: tpu_like_quad_core

# Define all cores in the HDA
cores:
  0: ./cores/accelerator1.yaml
  1: ./cores/accelerator2.yaml
offchip_core: ./cores/offchip.yaml

core_connectivity:
  # Single link connecting all cores
  - 0, 1
  # Links to offchip are automatically added

bandwidth: 32  # Bandwidth of the bus
unit_energy_cost: 0  # Link energy 
```

Lenet - 5 model
![lenet_5_model](attachments/inferred_lenet5.png)

## Observation on 1st Run of the Stream
1. There is only an ONNX parser in Stream and there is no yaml file parser which means there is no possibility of passing an workload in the custom format as it was done in the zigzag. 
2. Stream results are mainly focused on giving the intercore results and I couldn't find the intra core mapping results which are mainly required for the validation of the results

# Validation Results

# Implication of the differences in the results

# Proposed Solution


# Algorithm of the script that generates the possible mapping constraints





The lenet - 5 configuration is as follows

Input: 32x32x1
C1: 6 filters, 5x5 kernel, output 28x28x6
S2: 2x2 average pooling, stride=2, output 14x14x6
C3: 16 filters, 5x5 kernel, output 10x10x16
S4: 2x2 average pooling, stride=2, output 5x5x16
C5: 120 filters, 5x5 kernel (or fully connected), output 120
F6: Fully connected, output 84
Output: Fully connected, output 10

On modeling the lenet -5 on to the Single core architecture using zigzag the results are as follows compared to the actual event driven computing (Generate a table and a bar graph to compare)


On modeling the lenet - 5 on to the Multi-core architecture using zigzag the results are as follows compared to the actual event driven computing


---------------------------------------------------------------------------------------------------------------------------------------------------------------
# Sections

- [ ] Single core exploration
- [ ] Multi core exploration
- [ ] How does it work